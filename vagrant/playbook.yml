# Useful resources:
# http://www.stavros.io/posts/example-provisioning-and-deployment-ansible/
# https://github.com/azavea/ansible-gdal-netcdf
# https://github.com/snowplow/ansible-playbooks (see python-data-science.yml)
---
- hosts: all
  remote_user: vagrant

  vars:
    sources_dir: /usr/local/src
    conda_dir: /home/vagrant/miniconda
    dev_sources_dir: /home/vagrant/python
    data_dir: /home/vagrant/data

  tasks:
    - name: Install required system packages.
      apt: pkg={{ item }} state=installed update-cache=yes
      sudo: yes
      with_items:
        - git
        - libx11-dev
        - g++

    - name: Download Miniconda
      get_url:
        url: ftp://ftp.nersc.no/pub/Anton/Miniconda-latest-Linux-x86_64.sh
        #url: http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh
        dest: '{{ sources_dir }}/miniconda.sh'
      sudo: yes

    - name: Set Miniconda Owner
      file: path={{ sources_dir }}/miniconda.sh owner=vagrant group=vagrant mode=755
      sudo: yes

    - name: Install Miniconda
      shell: '{{ sources_dir }}/miniconda.sh -b -p {{ conda_dir }}'
      args:
        creates: '{{ conda_dir }}'

    - name: Add Miniconda PATH to .bashrc
      lineinfile: dest=/home/vagrant/.bashrc line="export PATH={{ conda_dir }}/bin:$PATH"

    - name: Update Miniconda
      shell: 'export PATH={{ conda_dir }}/bin:$PATH; conda update -q --yes conda'
      args:
        creates: '{{ conda_dir }}/conda-meta/history'

    - name: Install scientific Python packages
      shell: 'export PATH={{ conda_dir }}/bin:$PATH; conda install -q --yes {{ item }}'
      with_items:
        numpy
        scipy
        matplotlib
        nose
        pillow
        ipython
        ipython-notebook
        postgresql
        curl
        pycurl
        cython

    - name: Install GDAL packages from OSGEO
      shell: 'export PATH={{ conda_dir }}/bin:$PATH; conda install -q --yes -c osgeo {{ item }}'
      with_items:
        - gdal=1.11.2=np19py27_10
        - proj4
        - geos
        - xerces-c
        - libnetcdf=4.3.3.1=0
        - hdf5=1.8.14=10

    - name: Add GDAL_DATA to .bashrc
      lineinfile: dest=/home/vagrant/.bashrc line="export GDAL_DATA={{ conda_dir }}/share/gdal"

    - name: Install Basemap with PIP
      shell: 'pip install basemap --allow-external basemap --allow-unverified basemap'
      environment:
        PATH: "{{ conda_dir }}/bin:{{ ansible_env.PATH }}"
      args:
        creates: '{{ conda_dir }}/lib/python2.7/site-packages/basemap-1.0.7.dist-info'

    - name: Update/checkout Nansat
      git: repo=https://github.com/nansencenter/nansat
           dest="{{ dev_sources_dir }}/nansat/"
           version=develop
           update=yes

    - name: Install Nansat
      shell: 'python setup.py install'
      environment:
        PATH: "{{ conda_dir }}/bin:{{ ansible_env.PATH }}"
      args:
        chdir: '{{ dev_sources_dir }}/nansat'

    - name: Update/checkout OpenWind
      git: repo=https://github.com/nansencenter/openwind
           dest="{{ dev_sources_dir }}/openwind"
           version=develop
           update=yes

    - name: Install OpenWind
      shell: 'python setup.py install'
      environment:
        PATH: "{{ conda_dir }}/bin:{{ ansible_env.PATH }}"
      args:
        chdir: '{{ dev_sources_dir }}/openwind'

    - name: Create data folder
      sudo: no
      file: path="{{ data_dir }}" state=directory

    - name: Download Sentinel-1 sample acquisition
      sudo: no
      get_url:
        url: ftp://ftp.nersc.no/pub/python_test_data/sentinel1a/S1A_IW_GRDH_1SDV_20141003T053708_20141003T053737_002661_002F66_A2F4.zip
        dest: "{{ data_dir }}"

    - name: Add Ipython Notebook to crontab
      sudo: yes
      cron: name="Ipython Notebook" special_time=reboot job="{{ conda_dir }}/bin/ipython notebook --ip=0.0.0.0 --no-browser --notebook-dir=/home/vagrant/notebooks"

    #- name: Launch Ipython Notebook
    #  command: "{{ conda_dir }}/bin/ipython notebook --ip=0.0.0.0 --no-browser --notebook-dir=/home/vagrant/notebooks"
    #  sudo: yes
    #  async: 15
    #  poll: 0
